---
title: ''
output: pdf_document
header-includes:
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead{} % clear all header fields
  - \fancyfoot{} % clear all footer fields
  - \fancyfoot[R]{ED-LEAD code --- \thepage}
  - \renewcommand{\headrulewidth}{0pt} % remove header line
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

# Bayesian Analysis of Factorial Cluster Randomized Trials

A comprehensive simulation study comparing Bayesian and frequentist approaches for analyzing 2³ factorial cluster randomized trials, with applications to emergency department interventions.

## Overview

This repository contains code for conducting Monte Carlo simulation studies to evaluate statistical methods for factorial cluster randomized trials. The framework is designed for healthcare settings where multiple interventions are tested simultaneously across clustered units (e.g., emergency departments).

## Key Features

- **2³ Factorial Design**: Analyzes trials with three binary interventions (A, B, C) and all interactions
- **Cluster Randomization**: Accounts for clustering within healthcare sites using random effects
- **Bayesian Methods**: Implements hierarchical models with different prior specifications
- **Frequentist Comparison**: Includes hierarchical model selection via likelihood ratio tests
- **Power Analysis**: Determines required sample sizes based on posterior precision criteria
- **Prior Sensitivity**: Evaluates robustness to different prior assumptions

## Repository Structure

### R Programs

| File | Description |
|------|-------------|
| `01_data_generation.R` | Core functions for simulating factorial cluster randomized trial data |
| `02_prior_predictive.R` | Prior predictive checks to validate prior specifications |
| `03_bayesian_power.R` | Monte Carlo simulation for Bayesian power analysis and sample size determination |
| `04_comparison_study.R` | Comprehensive comparison of Bayesian and frequentist approaches |

### Stan Models

| File | Description |
|------|-------------|
| `model_HEX.stan` | **Hierarchical Exchangeable (HEx) Model**: Main Bayesian model with hierarchical priors for treatment effects |
| `model_nonX.stan` | **Non-Exchangeable Model**: Alternative specification without hierarchical structure |
| `model_HEX_ig.stan` | **HEx with Inverse Gamma Priors**: Variant using inverse gamma priors for scale parameters |
| `prior_predictive_model.stan` | **Prior Predictive Model**: Generates samples from prior distributions for prior checking |

## Study Design

### Treatment Structure
- **Control**: No interventions
- **Single Interventions**: A only, B only, C only
- **Two-way Combinations**: AB, AC, BC
- **Three-way Combination**: ABC

### Data Generation Process
1. **Cluster Level**: Random effects and group assignments (4 size categories)
2. **Time Structure**: Multiple quarters per cluster
3. **Individual Level**: Binary outcomes with logistic regression
4. **Effect Structure**: Main effects, two-way interactions, three-way interaction

### Model Specifications

The Bayesian models use the following hierarchical structure:
$$
logit(P(y_i = 1)) = \alpha_j[i] + \tau_a*A_i + \tau_b*B_i + \tau_c*C_i + 
                    \tau_{ab}*A_i*B_i + \tau_{ac}*A_i*C_i + \tau_{bc}*B_i*C_i + \tau_{abc}*A_i*B_i*C_i
$$

Where:
- $\alpha_j[i]$: Random effect for cluster j
- $\tau_a, \ \tau_b, \ \tau_c$: Main effects for treatments A, B, C
- $\tau_{ab}, \ \tau_{ac}, \ \tau_{bc}$: Two-way interaction effects  
- $\tau_{abc}$: Three-way interaction effect

## Getting Started

### Prerequisites

```{r}
# Required R packages
library(simstudy)     # Data simulation
library(data.table)   # Data manipulation
library(cmdstanr)     # Stan interface
library(posterior)    # Posterior analysis
library(glmmTMB)      # Frequentist mixed models
library(ggplot2)      # Visualization
library(ggpubr)       # Plot arrangements
library(parallel)     # Parallel computing
```

### Installation

1. Clone this repository:
```
git clone https://github.com/yourusername/factorial-cluster-trials.git
cd factorial-cluster-trials
```

2. Install required R packages:
```{r}
install.packages(c("simstudy", "data.table", "glmmTMB", "ggplot2", "ggpubr", "parallel"))
```

3. Install cmdstanr and Stan:
```{r}
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
cmdstanr::install_cmdstan()
```

## Simulation Parameters

### Study Design Parameters
- **Number of clusters**: 48-88 emergency departments
- **Intracluster correlation**: 0.015
- **Time periods**: 2 quarters per cluster
- **Cluster sizes**: Variable (60-300 patients per quarter)

### Treatment Effect Parameters
- **Baseline log-odds**: -0.40 ($\approx 40\%$ control rate)
- **Single intervention OR**: 0.80-0.82
- **Interaction effects**: Small positive or null

### Prior Specifications
Three scenarios representing different levels of informativeness:
1. **Informative**: Small prior SDs ($\sigma$ = 0.3-0.4)
2. **Moderate**: Medium prior SDs ($\sigma$ = 0.6-0.8)  
3. **Weakly informative**: Large prior SDs ($\sigma$ = 2.5)

## Key Analyses

### 1. Prior Predictive Checking
- Validates prior assumptions by examining implied outcome distributions
- Ensures priors allow for clinically meaningful effect sizes
- Identifies potential prior-data conflicts

### 2. Power Analysis
- Determines required sample size for adequate posterior precision
- Target: Posterior SD $\le$ 0.13 for interaction effects
- Monte Carlo estimation with 1000 replications per scenario

### 3. Method Comparison
- Bayesian hierarchical models vs. frequentist hierarchical model selection
- Type I error rates and power comparison
- Robustness to prior specifications

## Computational Requirements

- **Memory**: 8+ GB RAM recommended
- **CPU**: Multi-core processor for parallel processing
- **Time**: Full simulation study requires several hours/days on HPC
- **Dependencies**: Stan installation required

For large-scale simulations, high-performance computing (HPC) is recommended. Contact the authors for HPC setup guidance.

\newpage

## 01_data_generation.R

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("01_data_generation.R"), sep = "\n")
cat("\n```\n")
```

\newpage

## 02_prior_predictive.R

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("02_prior_predictive.R"), sep = "\n")
cat("\n```\n")
```

\newpage

## 03_sample_size.R

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("03_sample_size.R"), sep = "\n")
cat("\n```\n")
```

\newpage

## 04_comparison_study.R

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("04_comparison_study.R"), sep = "\n")
cat("\n```\n")
```

\newpage

## model_HEX.stan

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("model_HEX.stan"), sep = "\n")
cat("\n```\n")
```

\newpage

## model_HEX_ig.stan

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("model_HEX_ig.stan"), sep = "\n")
cat("\n```\n")
```

\newpage

## model_nonX.stan

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("model_nonX.stan"), sep = "\n")
cat("\n```\n")
```

\newpage

## prior_predictive_model.stan

```{r echo = FALSE, eval=TRUE, results='asis'}
cat("```r\n")
cat(readLines("prior_predictive_model.stan"), sep = "\n")
cat("\n```\n")
```



